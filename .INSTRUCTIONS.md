# CFCU Next.js Application - Technical Documentation

## Overview

This is a **Next.js 14** application for CFCU (Community Financial Credit Union) built with **Sanity CMS** as a headless content management system. The application uses the **Pages Router** architecture with server-side rendering (SSR), static site generation (SSG), and incremental static regeneration (ISR).

## Tech Stack

### Core Framework

- **Next.js 14.1.0** - React framework with Pages Router
- **React 18** - UI library
- **TypeScript** - Type safety

### CMS & Data Management

- **Sanity v3** - Headless CMS
- **@sanity/client** - Sanity client for data fetching
- **next-sanity** - Next.js integration with live preview
- **@sanity/vision** - GROQ query testing in Sanity Studio

### Styling & UI

- **Tailwind CSS** - Utility-first CSS framework
- **class-variance-authority** - Component variants
- **Radix UI** - Accessible component primitives (Accordion, Dropdown Menu)
- **Lucide React** - Icon library
- **Phosphor Icons** - Additional icon set

### Animation & Interactions

- **GSAP** - Animation library with ScrollTrigger and SplitText plugins
- **Framer Motion** - React animation library

### Additional Features

- **Mapbox GL** - Interactive maps for location features
- **Algolia Search** - Site search functionality
- **DOMPurify** - HTML sanitization

## Architecture

### Pages Router Structure

The application uses Next.js Pages Router with the following routing:

```
/                           → Homepage (pages/index.tsx)
/[...slug]                  → Dynamic catch-all for subpages (pages/[...slug].tsx)
/posts                      → Blog listing (pages/posts/index.tsx)
/posts/[slug]               → Individual blog posts (pages/posts/[slug].tsx)
/posts/topic/[slug]         → Posts by topic
/posts/page/[page]          → Paginated posts
/locations                  → Locations listing (pages/locations/index.tsx)
/locations/[slug]           → Individual location pages (pages/locations/[slug].tsx)
/search                     → Search results (pages/search.tsx)
/studio                     → Sanity Studio (app/studio/[[...index]])
```

### Key Architectural Patterns

#### 1. **Static Generation with Revalidation**

- Pages use `getStaticProps` with ISR (revalidate: 3600 seconds = 1 hour)
- On-demand revalidation via webhook endpoint (`/api/revalidate.ts`)
- Sanity webhooks trigger revalidation when content changes

#### 2. **Draft Mode / Live Preview**

- Draft mode enabled via `/api/draft` endpoint
- `useLiveQuery` hook provides real-time content updates in preview
- Token-based authentication for preview access

#### 3. **Global State Management**

- **Zustand** store (`stores/globalSettingsStore.ts`) manages global settings
- Settings loaded on every page and stored in state
- Includes navigation, alerts, embeds, and configuration

#### 4. **Middleware Layer**

- Handles `/go.php?bid=` redirects with caching
- Fetches redirect rules from Sanity
- 5-minute cache duration to reduce API calls

## Content Architecture

### Sanity Schema Types

#### Singletons

- **globalSettings** - Site-wide configuration (navigation, alerts, embeds)
- **homepage** - Homepage-specific content

#### Documents

- **subPage** - Standard content pages with modular sections
- **post** - Blog posts with authors and topics
- **location** - Physical branch locations with maps
- **author** - Blog post authors
- **topic** - Blog post categories

#### Objects

- Modular content blocks (CTAs, accordions, tabs, grids, etc.)
- WYSIWYG content with custom blocks
- Link types (internal, external)

### GROQ Queries

Complex GROQ queries are defined in `lib/sanity.queries.ts` and use fragments from `lib/sanity.modules.ts`:

- **Fragments** - Reusable query patterns for links, wysiwyg content, modules
- **Queries** - Page-specific queries (homepage, subpages, posts, locations)
- **Reference Resolution** - Deep object/reference resolution for navigation and links

## Component Structure

### Layout Components

```
components/layouts/
  ├── Layout.tsx          → Main layout wrapper with SEO
  └── CustomHead.tsx      → Meta tags and SEO configuration
```

### Page Components

```
components/pages/
  ├── IndexPage.tsx           → Homepage
  ├── SubPage.tsx             → Standard content pages
  ├── PostPage.tsx            → Blog post detail
  ├── PostHomePage.tsx        → Blog listing
  ├── LocationPage.tsx        → Location detail
  ├── LocationHomePage.tsx    → Locations listing
  ├── RatePage.tsx            → Rates page
  └── SearchResultsPage.tsx   → Search results
```

### Module System

The application uses a **modular content system** where pages are composed of reusable modules:

```
components/global/modules/
  ├── ModuleFactory.tsx           → Renders modules based on _type
  ├── RatesPageModuleFactory.tsx  → Special factory for rates modules
  ├── accordion.tsx
  ├── ctaCardGrid.tsx
  ├── ctaFullMedia.tsx
  ├── columnSplit.tsx
  ├── wysiwyg.tsx
  ├── siteAlert.tsx
  └── [other modules...]
```

**Module Pattern:**

1. Sanity schemas define module types in `schemas/documents/modules/`
2. GROQ queries fetch modules with all required fields
3. `ModuleFactory` component maps `_type` to React component
4. Each module is self-contained and receives its data as props

### Global Components

```
components/global/
  ├── Header.tsx       → Site navigation
  ├── Footer.tsx       → Site footer
  ├── Menu.tsx         → Mobile menu
  └── SearchBar.tsx    → Site search
```

## Data Fetching Flow

### Static Page Generation

```typescript
// Example from pages/index.tsx

export const getStaticProps: GetStaticProps = async (ctx) => {
  const { draftMode = false } = ctx

  // Get Sanity client (with token if in draft mode)
  const client = getClient(draftMode ? { token: readToken } : undefined)

  // Fetch data
  const globalSettings = await getGlobalSettings(client)
  const homepage = await getHomepage(client)

  // Generate SEO data
  const seo = {
    title: homepage?.metaTitle || 'CFCU',
    description: homepage?.metaDescription || '',
    image: homepage?.ogImage || '',
    keywords: homepage?.keywords || '',
  }

  return {
    props: { seo, globalSettings, homepage, draftMode, token },
    revalidate: 3600, // ISR: Revalidate every hour
  }
}
```

### Live Preview Mode

```typescript
// In page component
const [data] = useLiveQuery<HomepageType>(props.homepage, homepageQuery)

// data automatically updates when content changes in Sanity Studio
```

## Revalidation System

### On-Demand Revalidation

When content is updated in Sanity, a webhook calls `/api/revalidate.ts`:

1. Webhook payload includes document `_type`, `_id`, and `slug`
2. `queryStaleRoutes()` function determines which pages need revalidation
3. Routes are revalidated using `res.revalidate(route)`

**Supported revalidation paths:**

- Homepage: `/`
- Subpages: `/${slug}`
- Posts: `/posts/${slug}`, `/posts/topic/${topic}`, `/posts/page/${n}`
- Locations: `/locations/${slug}`, `/locations`
- Global settings trigger revalidation of all pages

## Sanity Studio Integration

### Studio Configuration

- Mounted at `/studio` route (using App Router in `app/studio/[[...index]]`)
- Custom configuration in `sanity.config.ts`
- Custom plugins:
  - **previewPane** - Side-by-side preview in Studio
  - **settingsPlugin** - Singleton settings management
  - **locate** - Content-to-page mapping for preview
  - **media** - Media library management
  - **simplerColorInput** - Color picker with brand colors

### Custom Studio Features

```
components/Sanity/
  ├── Logo.tsx                    → Custom Studio logo
  ├── PageHierarchyView.tsx       → Hierarchical page view
  ├── AutoPreviewPane.tsx         → Automatic preview pane
  ├── ChildrenOrderInput.tsx      → Drag-and-drop page ordering
  └── ArrayMembersWithoutActions.tsx → Read-only arrays
```

## Environment Variables

Required environment variables:

```env
# Sanity Configuration
NEXT_PUBLIC_SANITY_PROJECT_ID=       # Sanity project ID
NEXT_PUBLIC_SANITY_DATASET=          # Sanity dataset (production/development)
NEXT_PUBLIC_SANITY_API_VERSION=      # API version (e.g., 2023-06-21)
SANITY_API_READ_TOKEN=               # Read token for draft content

# Revalidation
SANITY_REVALIDATE_SECRET=            # Secret for webhook validation

# Mapbox (for location maps)
NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN=     # Mapbox access token

# Algolia Search
NEXT_PUBLIC_ALGOLIA_APP_ID=          # Algolia application ID
NEXT_PUBLIC_ALGOLIA_SEARCH_KEY=      # Algolia search-only key
```

## Image Optimization

The application uses Next.js Image component with Sanity image pipeline:

```typescript
// lib/sanity.image.ts
import imageUrlBuilder from '@sanity/image-url'

const builder = imageUrlBuilder(client)

export function urlForImage(source) {
  return builder.image(source).auto('format').fit('max')
}
```

**Image configuration:**

- AVIF and WebP formats
- Remote patterns: `cdn.sanity.io`, `source.unsplash.com`
- SVG support enabled

## Redirects

### Static Redirects

- Defined in `next.config.mjs`
- Fetched from Sanity `redirects` document type
- Built at compile time

### Dynamic Redirects (Middleware)

- `/go.php?bid=` redirects handled in `middleware.ts`
- Cached for 5 minutes to reduce Sanity API calls
- Useful for legacy URL support

## Search Functionality

The application implements search using **Algolia**:

1. **Search page** (`pages/search.tsx`) receives query parameter
2. **Search component** (`components/search/Search.tsx`) queries Algolia
3. **Results** displayed with pagination
4. Search indexes content from Sanity (subpages, posts, locations)

## Location Features

Location pages include:

- **Interactive maps** using Mapbox GL
- **Search box** for finding addresses
- **Location hours** display
- **Location grid** for browsing all locations
- Custom map markers and styling

## Animation System

### GSAP Integration

```typescript
// Registered plugins
import { gsap } from 'gsap'
import { ScrollTrigger } from 'gsap/dist/ScrollTrigger'
import { SplitText } from 'gsap/dist/SplitText'

gsap.registerPlugin(SplitText, ScrollTrigger)
```

**Common patterns:**

- Text splitting animations (`components/interaction/splitTextDynamic.tsx`)
- Scroll-triggered animations
- Page transition effects

### Framer Motion

Used for component-level animations and interactions.

## Custom Fonts

The application uses **Codec Pro** font family:

```typescript
// font.ts
import localFont from 'next/font/local'

export const CodecPro = localFont({
  src: './public/fonts/CodecPro-Regular.woff2',
  variable: '--font-codec-pro',
})
// ... other weights
```

Applied globally via `_app.tsx` with CSS variables.

## Error Handling

### Global Error Boundary

```tsx
// components/global/GlobalErrorBoundary.tsx
<GlobalErrorBoundary>
  <Component {...pageProps} />
</GlobalErrorBoundary>
```

### 404 Pages

- Custom 404 component: `components/pages/404Page.tsx`
- Rendered via `pages/404.tsx`
- Can be customized in Sanity

## Build & Deployment

### Build Process

```bash
npm run build          # Production build
npm run dev            # Development server
npm start              # Production server
npm run type-check     # TypeScript validation
npm run lint           # ESLint
```

### Deployment

- Configured for deployment on Liquid Web via GitHub Actions
- PM2 process manager (`ecosystem.config.js`)
- See `DEPLOYMENT.md` for detailed setup instructions

### Build Configuration

```javascript
// next.config.mjs
{
  typescript: {
    ignoreBuildErrors: process.env.VERCEL_ENV === 'production',
  },
  eslint: {
    ignoreDuringBuilds: process.env.VERCEL_ENV === 'production',
  },
}
```

## Performance Optimizations

1. **ISR** - Pages revalidate every hour, serving stale content while regenerating
2. **Image optimization** - Next.js Image component with Sanity CDN
3. **Code splitting** - Automatic by Next.js
4. **Lazy loading** - Components lazy loaded where appropriate
5. **Middleware caching** - Redirect rules cached for 5 minutes
6. **CDN** - Sanity assets served via CDN

## Development Workflow

### Adding a New Page Type

1. Create schema in `schemas/documents/`
2. Add to schema index `schemas/index.ts`
3. Create GROQ query in `lib/sanity.queries.ts`
4. Add query fragments to `lib/sanity.modules.ts`
5. Create page component in `components/pages/`
6. Add route in `pages/` directory
7. Update revalidation logic in `pages/api/revalidate.ts`
8. Add TypeScript types in `types/sanity/`

### Adding a New Module

1. Create schema in `schemas/documents/modules/`
2. Add to documents index
3. Create GROQ fragment in `lib/sanity.modules.ts`
4. Create component in `components/global/modules/`
5. Register in `ModuleFactory.tsx`
6. Add TypeScript types

### Testing Preview Mode

1. Navigate to `/api/draft?slug=/your-page-slug`
2. Make changes in Sanity Studio
3. See live updates without page refresh
4. Exit via `/api/disable-draft`

## Common Issues & Solutions

### Build Errors

- **TypeScript errors**: Check `tsconfig.json` and type imports
- **Missing env vars**: Ensure all required env vars are set
- **Sanity connection**: Verify project ID and dataset

### Preview Not Working

- Check `SANITY_API_READ_TOKEN` is set
- Verify preview secret configuration
- Check browser cookies for draft mode

### Redirects Not Working

- Static redirects: Check `next.config.mjs` build output
- Dynamic redirects: Check middleware logs
- Clear middleware cache (wait 5 minutes)

### Images Not Loading

- Verify Sanity CDN domain in `next.config.mjs` remote patterns
- Check image references in Sanity content
- Validate Sanity image URLs

## Additional Resources

- **Next.js Docs**: https://nextjs.org/docs
- **Sanity Docs**: https://www.sanity.io/docs
- **GROQ Docs**: https://www.sanity.io/docs/groq
- **Tailwind CSS**: https://tailwindcss.com/docs
- **GSAP Docs**: https://greensock.com/docs/

## Project Structure Summary

```
/
├── app/                        # App Router (Studio only)
├── pages/                      # Pages Router (main application)
├── components/                 # React components
│   ├── pages/                 # Page-level components
│   ├── global/                # Shared components
│   │   └── modules/          # Content modules
│   ├── layouts/              # Layout wrappers
│   └── Sanity/               # Studio customizations
├── lib/                       # Utility functions
│   ├── sanity.api.ts         # API configuration
│   ├── sanity.client.ts      # Client setup
│   ├── sanity.queries.ts     # GROQ queries
│   ├── sanity.modules.ts     # Query fragments
│   └── sanity.image.ts       # Image utilities
├── schemas/                   # Sanity schemas
│   ├── documents/            # Document types
│   ├── objects/              # Object types
│   ├── singletons/           # Singleton types
│   └── settings/             # Settings types
├── stores/                    # State management
├── types/                     # TypeScript definitions
├── styles/                    # Global styles
├── public/                    # Static assets
├── middleware.ts             # Next.js middleware
├── sanity.config.ts          # Sanity Studio config
└── next.config.mjs           # Next.js config
```

---

**Last Updated**: December 5, 2025
**Version**: Next.js 14 with Sanity v3
**Maintained By**: Outkast Studio / PriWorks
